# transport-data-analyzer


GitHub Copilot を活用して開発を進めるための、**「プロンプト用 兼 開発仕様書」**を作成しました。これを README.md として GitHub に配置したり、Copilot Chat にペーストしたりすることで、AI が文脈を正確に理解し、高精度なコードを出力できるようになります。
輸送業務データ一括解析ツール 仕様書 (Data Aggregation Tool Spec)
1. プロジェクト概要
Google ドライブ（ローカル同期済み）またはローカルフォルダにある、約 200 ファイルの輸送業務関連エクセルファイルからデータを抽出し、統一された 4 つの CSV データベースを作成する。
2. 実行環境・技術スタック
 * Frontend: HTML5, CSS3, JavaScript (Vanilla JS)
 * Library: SheetJS (xlsx.js) ※ローカルファイル xlsx.full.min.js を使用
 * Editor: VS Code + GitHub Copilot
 * Environment: Web Browser (Chrome/Edge) - ローカル実行（Security: Tracking Prevention 回避策が必要）
3. 入力データ定義
3.1 フォルダ構造 (Folder Hierarchy)
ファイルパスから以下のメタデータを抽出する：
[会計期(例: 18期)] / [グループ(例: ア行)] / [管理用企業名] / [エクセルファイル名]
3.2 エクセルファイル構成 (Excel Structure)
 * ファイル形式: .xlsx (複数シート構成)
 * シート名の規則: 「DB」「請求」「支払」というキーワードを含むシートを対象とする（例: DB25.11, 請求25.11）。1ファイルに複数月分のシートが存在する。
 * レイアウト特性: セルの入力位置や列順が固定されていない。キーワード検索による動的特定が必須。
3.3 マスターデータ (Master Data)
読み込み時に以下のマスタと照合し、ID 等を付与する：
 * 企業マスタ: キー=企業名。項目=企業No, 締日, 支払日 等。
 * 案件マスタ: キー=氏名。項目=インボイス番号, 契約単価, 事務手数料 等。
4. 解析・抽出ロジック (Extraction Logic)
4.1 基本戦略：キーワード・アンカー方式
特定の文字列（ラベル）を検索し、その相対位置から値を取得する。
 * 右方向スキャン: ラベルの右隣から右端に向かってスキャンし、最初に見つかった非空値をデータとする。
 * 下方向スキャン: 「始業」「終業」等のヘッダー行を特定し、その1行下からデータ終了（「合計」等の文字出現）までループする。
4.2 抽出エリア定義 (DBシート)
 * 日次エリア: 日付、始業、終業、超過数、出勤日数、備考。
 * 売上エリア: 「売上」ヘッダーの下にある可変行（日極、時間超過等）と「総売上額」。
 * 支払エリア: 「支払」ヘッダーの下にある可変行と「実際支払額」。
 * 控除エリア: 手数料、会費、車両代、調整等の固定ラベルの右側の値。
 * 収支: 粗利。
5. 出力データ定義 (Output CSVs)
以下の 4 つの CSV ファイルを「BOM付き UTF-8」で出力する：
 * daily_data.csv (日次明細)
   * 項目: 会計期, 企業名, パートナー氏名, 日付, 始業, 終業, 超過数, 備考, マスタ企業No...
 * pl_data.csv (月次収支・控除)
   * 項目: 会計期, 企業名, パートナー氏名, 月度, 総売上額, 総支払額, 実際支払額, 粗利, 手数料, 会費, 車両代...
 * invoice_summary.csv (請求管理用)
   * 項目: 請求書シートから抽出した合計額と宛先情報。
 * payout_summary.csv (支払管理用)
   * 項目: 支払書シートから抽出した振込予定日、金額、インボイス番号。
6. バリデーション (Verification)
 * DBシートの総売上 == 請求書の合計金額
 * DBシートの実際支払額 == 支払書のお支払金額
 * 上記に乖離がある場合、ログに警告を表示し、CSV にエラーフラグを立てる。
7. GitHub Copilot への指示用プロンプト案
以下のテキストを Copilot に入力して開発を依頼してください。
> 「輸送業務の Excel 解析ツールを作成してください。SheetJS を使用して、フォルダ内の約 200 個の .xlsx ファイルを読み込みます。各ファイルには複数月のシート（DB25.11 等）があります。セルの位置が不定なため、'総売上額' や '粗利' といったキーワードをシート全体から検索し、その右側の数値を取得するロジックを実装してください。抽出結果は、日次明細と月次サマリーを含む 4 つの CSV ファイルとして一括出力してください。マスタデータとの紐付け機能と、金額の整合性チェック機能も含めてください。」
> 
次のステップ：GitHub での管理
 * Repository 作成: transport-data-analyzer などの名前でリポジトリを作成。
 * README.md: 上記の仕様書を貼り付ける。
 * .gitignore: *.xlsx や *.csv を含め、機密データが GitHub に上がらないように設定。
 * Copilot Chat 活用: 仕様書の特定のセクション（例：「4.2 抽出エリア定義の詳細ロジックを書いて」）を指定してコードを生成させる。
この仕様書をもとに進めれば、Copilot はかなり精度の高いコードを生成してくれるはずです。GitHub での構築中に具体的なエラーやロジックの壁にぶつかったら、またいつでも相談してくださいね！

---

## 実装済みソース（このリポジトリ）

以下のファイルを追加し、ブラウザ上で実行できる MVP を実装しています。

- `index.html` : 入力UI（フォルダ選択、マスタCSV選択、実行、CSVダウンロード）
- `styles.css` : 最小スタイル
- `app.js` : Excel解析、マスタ照合、整合性チェック、CSV生成

### 実行手順

1. このリポジトリ直下に `xlsx.full.min.js`（SheetJS）を配置する
2. `index.html` をブラウザで開く
3. 必要なら先に「マスター生成」で企業/案件の元データ（CSV/TSV）を取り込み、「マスターを生成」を実行する
4. 「Excelフォルダ（再帰）」で `.xlsx` を含むフォルダを選択する
5. 既存マスターを使う場合は企業マスタCSV・案件マスタCSVを選択する（生成済みマスターがある場合はそちらが優先）
6. 「解析してCSVを生成」を押し、生成された4つのCSVをダウンロードする

### マスター生成ルール

- `input_data.md` に記載の項目順で、企業マスター/案件マスターを出力します
- `企業No` が空の場合は `C0001` 形式で採番します
- `事業所No` が空の場合は、同一企業内で `Z001` 形式で採番します
- `案件マスター` の `企業No` / `事業所No` が空の場合は、`datachanger.md` を踏襲した正規化＋曖昧一致（レーベンシュタイン距離）で企業を補完します
- 補完できない場合は、新規企業を企業マスターへ追加し、番号を自動付与します

### 入力の前提

- `webkitRelativePath` から `[会計期]/[グループ]/[企業名]/[ファイル名]` を推定します
- シート名に `DB` / `請求` / `支払` を含むシートを対象にします
- 固定座標ではなく、ラベル検索＋右方向スキャンで主要値を抽出します

### 出力ファイル

- `daily_data.csv`
- `pl_data.csv`
- `invoice_summary.csv`
- `payout_summary.csv`

すべて BOM 付き UTF-8 で出力します。
